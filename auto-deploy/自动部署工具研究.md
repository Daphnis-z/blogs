# 1. 前言

先来看下传统的部署方式：

- 运维人员手工使用 Scp、Xftp 等方式来传输数据
- 开发人员手工登录服务器执行 git pull 、svn update 等命令获取最新的代码
- 开发人员手工编译打包，然后通过内网传输给运维人员
- 运维人员将安装包上传到目标服务器，然后，执行重命名原包、拷贝新包到目标目录，再执行服务应用重启命令完成整个部署过程

传统的部署方式，需要多人、多个角色的互相配合，导致**部署耗时长**，且**容易出错**。

现在公司产品一般比较多，如果全部采用传统的部署方式，时间和人力的消耗都变得不可接受。因此，**自动部署工具**应运而生，当开发人员提交代码后，**及时进行编译**，编译不过可以邮件通知，还可以设置定时**自动编译安装包**、**自动更新应用**，效率的提升是显而易见的。

# 2. 自动部署运维工具

下面挑选了目前比较流行的几款自动部署工具进行简要介绍：

## 2.1 Jenkins

一个可以自动化各种任务，如构建，测试和部署软件的开源持续集成工具。

特点如下：

- **易安装**，仅仅一个 java -jar jenkins.war，从官网下载该文件后，直接运行，无需额外的安装，更无需安装数据库；
- **易配置**，提供友好的GUI配置界面；
- **变更支持**，能从代码仓库（Subversion/CVS）中获取并产生代码更新列表并输出到编译输出信息中；
- 支持使用 **邮件**、**即时通讯工具** 发送集成结果；
- 支持**分布式构建**，可以把集成构建等工作分发到多台计算机中完成；
- 提供**测试报告**，以图表等形式提供详细的测试报表功能；
- 支持**第三方插件**；

## 2.2 Ansible

一个基于 Python ，默认使用 SSH 进行连接，模型驱动的自动化部署、运维工具。

官网：https://www.ansible.com/

特点如下：

- **模块化的设计**，能够调用特定的模块来完成特定任务 ，本身是核心组件，短小精悍 ；
- 基于 **Python语言** 实现，由 Paramiko , PyYAML 和 Jinja2 ( 模板化 ) 三个关键模块实现； 
- **部署简单**，无需安装客户端； 
- 以**主从模式**工作； 
- 支持**自定义模块**功能； 
- 支持 **playbook 剧本**，任务按预定义顺序依次执行； 

https://www.w3cschool.cn/automate_with_ansible/

## 2.3 Puppet

一个基于 Ruby ，功能全面、稳定、成熟的服务器自动化配置管理工具。

官网： https://puppet.com/ 

特点如下：

- **社区活跃**，通过 Puppet Labs 建立良好的支持社区；
- **跨平台**，有最成熟的接口，几乎可以在每个操作系统上运行；
- **容易安装**，简单的安装和初始设置；
- **完备的管理界面**，Web UI 十分完备，易用性强；
- **报告功能强大**；

## 2.4 Chef

一个基于 Ruby ，支持系统管理、安装软件等功能的服务器自动化配置工具。

官网： https://www.chef.io/ 

特点如下：

- **模块和配置丰富**；
- **功能强灵活性好**，基于代码驱动；
- **版本控制**，围绕 Git 提供强大的版本控制功能；
- **安装简单**，“Knife”工具（使用SSH从工作站部署代理）减轻了安装负担；

## 2.5 SaltStack

一个基于 Python ，具备配置管理、远程执行、监控等功能的服务器基础架构集中化管理平台。

官网： https://www.saltstack.com/

特点如下：

- **通用**，从几台到上万台服务器都可以用；
- **并行执行**，命令是并行发送到多台服务器，效率高；
- **安全快速**，使用安全加密的协议，网络载荷小；
- **灵活**，提供了简单的编程接口；

# 3 选择合适的自动部署工具

Jenkins 跟另外四种工具针对的问题场景区别比较大，它是一个平台级的工具，用于研发阶段的编译、安装、测试等。而其他四种工具主要是解决服务器集群的配置管理，用于复杂系统的自动部署。

接下来看下另外四个工具：

| 工具      | 语言   | 架构            | 协议         |
| --------- | ------ | --------------- | ------------ |
| Puppet    | Ruby   | C/S             | HTTP         |
| Chef      | Ruby   | C/S             | HTTP         |
| Ansible   | Python | 无Client        | SSH          |
| Saltstack | Python | C/S(可无Client) | SSH/ZMQ/RAET |

由于 Puppet 和 Chef 是基于 Ruby 的，在语言方面比不上基于 Python 的 Ansible 和 SaltStack，毕竟现在 Python 的流行程度和开发人员的数量都要强于 Ruby，所以接下来主要从 **大规模并发**、**开发扩展**、**社区活跃度**、**学习成本** 等几方面对比下 Ansible 和 SaltStack。

1. **大规模并发的能力**

   因为实现机制的差异，SaltStack 在这方面是占优的。不过对于 **200台**以内规模的集群来说，Ansible 的性能也是可以接受的。 

   另外 Ansible 的执行架构已经有所优化，采用基于 MQ 的 agent 机制，已支持管理比较大规模（1000-10000台）的服务器集群了。

2. **二次开发扩展的能力**

   ansible 和 saltstack 都是基于 python 的，而 python 在运维开发这个圈子里接受度还是非常高的，二次开发的人员相对较多。 
   ansible 和 saltstack 都具备很好的二次开发扩展能力，可以写 YAML 编排，这一点上势均力敌。

3. **社区活跃度**

   在 github上，ansbile 有 43.5k 星星，salt有 11.1k 星星。 
   直接按关键字搜索，ansible 的相关项目也更多一些。 
   这些指标虽然不能直接说明什么，但很多技术人员会关注自己所使用的技术的活跃度。 一般来说，越活跃的开源项目，得到的关注会更高些，功能完善和问题解决的效率也会更高，遇到问题也更容易找到解决方案。

4. **学习成本**

   从第一次使用来讲，ansible 的部署配置会更简单一些。 
   从官方文档的质量来看，saltstack 就比 ansible 要好一些。 

5. **用户规模**

   根据 rightscale 的调研报告： 
   	Ansible 在 2015年有 10%的用户选用，而 2016年有 20%的用户选用。 Saltstack 在 2015年有 6%的用户选用，而2016年有 9%的用户选用。

6. **第三方工具丰富程度**

   ansibe 有一个 galaxy 站点：Ansible Galaxy ，https://galaxy.ansible.com/explore#/
   这个站点集合了 3000多个第三方开发的 Role/Playbook。 
   salt也有一些预先写好的 Formulas（Formulas are pre-written Salt States） 
   官方地址：Salt Formulas ，https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html

   目前已有的 Formulas 大概在 200个左右，比 ansible galaxy少了一个数量级，不过大部分常用软件也覆盖到了。

7. **对 windows 的支持程度**

   ansible 对 windows 的支持简直不忍直视，agentless 只是对于 linux 的，windows 要安装 bug 修复补丁，powershell 还要3.0，还要安装 python。还不如 salt 方便。salt 有对 windows 的支持，但是也不是很好。

工具的选用第一个还是看服务器集群的规模，如果规模在 **200台**以上，建议选用 **SaltStack** ，否则 **Ansible** 是一个很好的选择。另外，如果是部署一些复杂系统，比如 数据预处理、实时分析、业务处理系统，这些系统一般需要在多台机器上安装多个程序，用 **Ansible** 来做系统的**一键安装**也是很适合的。